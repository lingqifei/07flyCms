<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5><i class="fa fa-home"></i> 系统菜单</h5>
                </div>
                <div class="ibox-content">

                    <div class="row">
                        <div class="col-md-12">
                            <button id="btnAdd" class="btn  btn-info btn-outline" >添加节点</button>
                            <button id="btnDel" data-url="{:url('SysMenu/del')}" data-id="0" class="btn btn-danger">删除节点</button>
                        </div>
                    </div>
                    <hr>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="panel panel-primary ">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-sm-6">菜单栏目</div>
                                        <div class="col-sm-6 text-right"><a>刷新</a></div>
                                    </div>
                                </div>
                                <div class="panel-body right_centent" style="">
                                    <div id="left-tree" data-url="{:url('SysMenu/get_list_tree')}">

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="panel panel-primary ">
                                <div class="panel-heading">
                                    <h3 class="panel-title">编辑区</h3>
                                </div>
                                <!--编辑操作权限 start-->
                                <div class="panel-body right_centent">
                                    <div id="editShow" data-url="{:url('SysMenu/edit')}">
                                        <form class="form-horizontal addForm" method="post"
                                              action="{:url('SysMenu/edit')}">
                                            <div class="ibox-content" role="document">
                                                <input type="hidden" name="id" value="0">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">菜单ID</label>
                                                    <div class="col-sm-8">
                                                        <input name="id" class="form-control" type="text" value="0"
                                                               readonly/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">父级ID</label>
                                                    <div class="col-sm-8">
                                                        <input name="pid" class="form-control" type="text"
                                                               placeholder="请输菜单上级ID，根菜单为0" value="0"/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">菜单名称</label>
                                                    <div class="col-sm-8">
                                                        <input name="name" class="form-control" type="text"
                                                               placeholder="请输中文栏目名称" required/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">ICON图标</label>
                                                    <div class="col-sm-8">
                                                        <input name="icon" class="form-control" type="text"
                                                               placeholder="ICON图标"
                                                               required/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">模块名称</label>
                                                    <div class="col-sm-8">
                                                        <input name="module" class="form-control" type="text"
                                                               placeholder="请输模块名称名称" required/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">链接地址</label>
                                                    <div class="col-sm-8">
                                                        <input name="url" class="form-control" type="text"
                                                               placeholder="请输入超链接地址"/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">排位序号</label>
                                                    <div class="col-sm-8">
                                                        <input name="sort" class="form-control" type="digits"
                                                               placeholder="栏目排序号"/>
                                                        <span class="help-block m-b-none"></span></div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">是否菜单</label>
                                                    <div class="col-sm-8">
                                                        <input type="radio" name="is_menu" value="1"> 是
                                                        <input type="radio" name="is_menu" value="0"> 否
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">是否启用</label>
                                                    <div class="col-sm-8">
                                                        <input type="radio" name="visible" value="1">是
                                                        <input type="radio" name="visible" value="0">否
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-offset-2 col-sm-8">
                                                        <button type="button" class="btn  btn-info save-form">
                                                            <span class="ladda-label"><i
                                                                    class="fa fa-send"></i>确 定</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <!--编辑操作权限 end-->
                            </div>
                        </div>
                    </div>
                    <!--弹出框 新增权限 start-->
                    <div class="row">
                        <div class="modal" id="addOperation">
                            <form class="form-horizontal addForm" method="post" action="{:url('SysMenu/add')}">
                                <div class="ibox-content" role="document">
                                    <input type="hidden" name="pid" value="0">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">菜单名称</label>
                                        <div class="col-sm-8">
                                            <input name="name" class="form-control" type="text" placeholder="请输中文栏目名称"
                                                   required/>
                                            <span class="help-block m-b-none"></span></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">模块名称</label>
                                        <div class="col-sm-8">
                                            <input name="module" class="form-control" type="text" placeholder="请输模块名称名称"
                                                   required/>
                                            <span class="help-block m-b-none"></span></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">ICON图标</label>
                                        <div class="col-sm-8">
                                            <input name="icon" class="form-control" type="text" placeholder="ICON图标"
                                                   required/>
                                            <span class="help-block m-b-none"></span></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">链接地址</label>
                                        <div class="col-sm-8">
                                            <input name="url" class="form-control" type="text" placeholder="请输入超链接地址"/>
                                            <span class="help-block m-b-none"></span></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">排位序号</label>
                                        <div class="col-sm-8">
                                            <input name="sort" class="form-control" type="digits" placeholder="栏目排序号"/>
                                            <span class="help-block m-b-none"></span></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">是否菜单</label>
                                        <div class="col-sm-8">
                                            <input type="radio" name="is_menu" value="1"> 是
                                            <input type="radio" name="is_menu" value="0"> 否
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">是否启用</label>
                                        <div class="col-sm-8">
                                            <input type="radio" name="visible" value="1">是
                                            <input type="radio" name="visible" value="0">否
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-offset-2 col-sm-8">
                                            <button type="button" class="btn  btn-info save-form">
                                                <span class="ladda-label"><i class="fa fa-send"></i>确 定</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!--弹出框 新增权限 end-->
                </div>
            </div>
        </div>
    </div>
</div>
<link href="__STATIC__/admin/js/plugins/bootstrap-treeview/bootstrap-treeview.min.css" rel="stylesheet">
<script src="__STATIC__/admin/js/plugins/bootstrap-treeview/bootstrap-treeview.js"></script>
<script type="text/javascript">
    $(function () {
        onLoad();
        //BindEvent();
        //页面加载
        function onLoad() {
            var target = $('#left-tree').attr('data-url');
            $.get(target).success(function (jsonData) {
                //渲染树
                $('#left-tree').treeview({
                    data: jsonData,
                    levels: 1,
                    showTags: false,//显示右边tags
                    showCheckbox: false,//是否显示多选
                    multiSelect: false,
                    onNodeSelected: function (event, node) {

                        //设置新增时的父节点
                        $('.addForm').find("input[name='pid']").val(node.id);

                        //设置当前节点编号
                        $("#btnDel").attr('data-id', node.id);

                        //输出编辑区域
                        var form, url;
                        form = $("#editShow").find("form");
                        url = form.get(0).action + '?id=' + node.id;
                        getInfo(form, url);

                    }

                });
            }, "json");
        }

        //显示-添加
        $("#btnAdd").click(function () {
            var node = $('#left-tree').treeview('getSelected');
            index = layer.open({
                type: 1,
                shade: false,
                title: false, //不显示标题
                area: ['800px', '640px'],
                content: $('#addOperation').html()
            });
        });

        //保存-编辑
        $("body").on("click", ".save-form", function () {
            var form, FormData, target, text;
            form = $(this).parents('form');
            text = form.find("input[name='name']").val();
            FormData = form.serialize();
            log(FormData);
            target = form.get(0).action;
            $.ajax({
                type: "POST",
                url: target,
                data: FormData,
                dataType: "json",
                success: function (data) {
                    if (data.code) {
                        layer.msg('操作成功', {icon: 1});
                        //静态添加节点
                        var parentNode = $('#left-tree').treeview('getSelected');
                        if (data.id == '0') {
                            var node = {text: text};
                            $('#left-tree').treeview('updateNode', [parentNode, node]);
                        } else {
                            var node = {text: text,id: data.id};
                            $('#left-tree').treeview('addNode', [node, parentNode]);
                        }
                        setTimeout(function () {
                            //关闭窗口
                            layer.close(index);
                        }, 800);
                    } else {
                        layer.msg(data.msg, {icon: 5});
                    }
                }
            });
        });


        //删除
        $("#btnDel").click(function () {
            var node = $('#left-tree').treeview('getSelected');

            var target = $(this).attr("data-url");
            var id = $(this).attr("data-id");

            var target = target + '?id=' + id;

            log(target);
            if (node.length == 0) {
                layer.msg('请选择节点', {icon: 1});
                return false;
            }
            if (!confirm('确认要执行该操作吗?')) {
                return false;
            } else {
                $.ajax({
                    dataType: 'json',
                    url: target,
                    async: false,//这里选择同步为false，那么这个程序执行到这里的时候会暂停，等待
                    success: function (data) {
                        if (data.code) {
                            layer.msg(data.msg, {icon: 1});
                            $('#left-tree').treeview('removeNode', [node, {silent: true}]);
                        } else {
                            layer.msg(data.msg, {icon: 5});
                        }
                    }
                });
            }
        });


        /*-----页面pannel内容区高度自适应 start-----*/
        $(window).resize(function () {
            setCenterHeight();
        });
        setCenterHeight();

        function setCenterHeight() {
            var height = $(window).height();
            var centerHight = height - 240;
            $(".right_centent").height(centerHight).css("overflow", "auto");
        }

        /*-----页面pannel内容区高度自适应 end-----*/
    });

    //获取树数据=>显示到编辑区中去
    function getInfo(form, target) {
        var data;
        $.ajax({
            dataType: 'json',
            url: target,
            async: false,//这里选择同步为false，那么这个程序执行到这里的时候会暂停，等待
            success: function (data) {
                form.setForm(data);
            }
        });
    }


</script>